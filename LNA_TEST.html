<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>LNA Watcher</title>
<style>
  body.lna-blocked > *:not(#lna-dialog) {
    display: none !important;
  }

  #lna-dialog {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    color: #fff;
    display: none;
    z-index: 999999;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }

  #lna-dialog.show {
    display: flex;
  }

  .box {
    background: #222;
    padding: 30px 40px;
    border-radius: 12px;
    max-width: 420px;
    text-align: center;
  }
</style>
</head>
<body>

<div id="lna-dialog">
  <div class="box">
    <h2>로컬 네트워크 접근 권한 필요</h2>
    <p>
      이 기능을 사용하려면<br>
      <strong>Local Network Access 허용</strong>이 필요합니다.
    </p>
    <p style="opacity:.7;margin-top:16px">
      브라우저 권한 요청이 곧 표시됩니다.
    </p>
  </div>
</div>

<script>
(async () => {
  const dialog = document.getElementById("lna-dialog");

  let lastState = null;

  function showDialog() {
    document.body.classList.add("lna-blocked");
    dialog.classList.add("show");
  }

  function hideDialog() {
    document.body.classList.remove("lna-blocked");
    dialog.classList.remove("show");
  }

  async function queryLNA() {
    try {
      return await navigator.permissions.query({
        name: "local-network-access"
      });
    } catch (e) {
      console.warn("LNA permission API not supported:", e);
      return null;
    }
  }

  async function triggerPrompt() {
    try {
      // 실제 prompt를 띄우기 위한 localhost 접근
      await fetch("http://127.0.0.1", {
        mode: "cors"
      });
    } catch (_) {
      // 실패해도 prompt는 뜸
    }
  }

  async function watchPermission() {
    const perm = await queryLNA();
    if (!perm) return;

    if (perm.state !== lastState) {
      lastState = perm.state;

      if (perm.state === "prompt") {
        console.log("[LNA] state = prompt");
        showDialog();
        triggerPrompt();
      }

      if (perm.state === "granted") {
        console.log("[LNA] state = allow");
        hideDialog();
      }

      if (perm.state === "denied") {
        console.log("[LNA] state = block");
        hideDialog();
      }
    }
  }

  // polling (현재 가능한 유일한 방법)
  setInterval(watchPermission, 500);
})();
</script>

</body>
</html>